<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aayush Agrawal">
<meta name="dcterms.date" content="2025-12-28">

<title>Diversity in Recommendations - Determinantal Point Processes (DPP) – Aayush Agrawal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8fedceaa9c5b51e05daa085a98af5997.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-af8a908a13f4fda948c7407926ad6c39.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-8fedceaa9c5b51e05daa085a98af5997.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-7QN8N70N41"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-7QN8N70N41', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Diversity in Recommendations - Determinantal Point Processes (DPP) – Aayush Agrawal">
<meta property="og:description" content="Aayush’s personal website">
<meta property="og:image" content="https://aayushmnit.com/posts/2025-12-28-DiversityDPPPart2/dpp_infographic.png">
<meta property="og:site_name" content="Aayush Agrawal">
<meta property="og:image:height" content="1536">
<meta property="og:image:width" content="2752">
<meta name="twitter:title" content="Diversity in Recommendations - Determinantal Point Processes (DPP) – Aayush Agrawal">
<meta name="twitter:description" content="Aayush’s personal website">
<meta name="twitter:image" content="https://aayushmnit.com/posts/2025-12-28-DiversityDPPPart2/dpp_infographic.png">
<meta name="twitter:creator" content="@aayushmnit">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1536">
<meta name="twitter:image-width" content="2752">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Aayush Agrawal</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-house" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> <i class="bi bi-newspaper" role="img">
</i> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> <i class="bi bi-file-person" role="img">
</i> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-other" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-stack" role="img">
</i> 
 <span class="menu-text">Other</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-other">    
        <li>
    <a class="dropdown-item" href="https://aayushmnit.com/pytorch_book/"><i class="bi bi-box-arrow-up-right" role="img">
</i> 
 <span class="dropdown-text">Pytorch Book</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../other/carlson.html"><i class="bi bi-box-arrow-up-right" role="img">
</i> 
 <span class="dropdown-text">Carlson Q&amp;A</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../talks.html"><i class="bi bi-megaphone" role="img">
</i> 
 <span class="dropdown-text">Talks</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://medium.com/@aayushmnit"> <i class="bi bi-bell" role="img">
</i> 
<span class="menu-text">Subscribe</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/aayushmnit/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/aayushmnit/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://medium.com/@aayushmnit"> <i class="bi bi-medium" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/aayushmnit"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:aayushmnit@gmail.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#linear-algebra-refresher-determinants-as-volume" id="toc-linear-algebra-refresher-determinants-as-volume" class="nav-link active" data-scroll-target="#linear-algebra-refresher-determinants-as-volume">Linear Algebra Refresher: Determinants as Volume</a></li>
  <li><a href="#dpp-fundamentals-from-volume-to-probability" id="toc-dpp-fundamentals-from-volume-to-probability" class="nav-link" data-scroll-target="#dpp-fundamentals-from-volume-to-probability">DPP Fundamentals: From Volume to Probability</a></li>
  <li><a href="#quality-vs-diversity-decomposition" id="toc-quality-vs-diversity-decomposition" class="nav-link" data-scroll-target="#quality-vs-diversity-decomposition">Quality vs Diversity Decomposition</a></li>
  <li><a href="#greedy-map-the-practical-dpp-algorithm" id="toc-greedy-map-the-practical-dpp-algorithm" class="nav-link" data-scroll-target="#greedy-map-the-practical-dpp-algorithm">Greedy MAP: The Practical DPP Algorithm</a>
  <ul class="collapse">
  <li><a href="#walking-through-greedy-map-step-by-step" id="toc-walking-through-greedy-map-step-by-step" class="nav-link" data-scroll-target="#walking-through-greedy-map-step-by-step">Walking Through Greedy MAP Step-by-Step</a></li>
  <li><a href="#the-complete-implementation" id="toc-the-complete-implementation" class="nav-link" data-scroll-target="#the-complete-implementation">The Complete Implementation</a></li>
  </ul></li>
  <li><a href="#tuning-the-quality-diversity-tradeoff" id="toc-tuning-the-quality-diversity-tradeoff" class="nav-link" data-scroll-target="#tuning-the-quality-diversity-tradeoff">Tuning the Quality-Diversity Tradeoff</a>
  <ul class="collapse">
  <li><a href="#youtubes-kernel-parameterization" id="toc-youtubes-kernel-parameterization" class="nav-link" data-scroll-target="#youtubes-kernel-parameterization">YouTube’s Kernel Parameterization</a></li>
  <li><a href="#understanding-the-parameters" id="toc-understanding-the-parameters" class="nav-link" data-scroll-target="#understanding-the-parameters">Understanding the Parameters</a></li>
  <li><a href="#sweeping-the-α-parameter" id="toc-sweeping-the-α-parameter" class="nav-link" data-scroll-target="#sweeping-the-α-parameter">Sweeping the α Parameter</a></li>
  <li><a href="#sweeping-the-σ-parameter" id="toc-sweeping-the-σ-parameter" class="nav-link" data-scroll-target="#sweeping-the-σ-parameter">Sweeping the σ Parameter</a></li>
  <li><a href="#visualizing-the-rbf-kernel" id="toc-visualizing-the-rbf-kernel" class="nav-link" data-scroll-target="#visualizing-the-rbf-kernel">Visualizing the RBF Kernel</a></li>
  <li><a href="#practical-guidance" id="toc-practical-guidance" class="nav-link" data-scroll-target="#practical-guidance">Practical Guidance</a></li>
  </ul></li>
  <li><a href="#youtubes-production-dpp-implementation" id="toc-youtubes-production-dpp-implementation" class="nav-link" data-scroll-target="#youtubes-production-dpp-implementation">YouTube’s Production DPP Implementation</a>
  <ul class="collapse">
  <li><a href="#the-windowed-algorithm" id="toc-the-windowed-algorithm" class="nav-link" data-scroll-target="#the-windowed-algorithm">The Windowed Algorithm</a></li>
  <li><a href="#walking-through-the-windowed-algorithm" id="toc-walking-through-the-windowed-algorithm" class="nav-link" data-scroll-target="#walking-through-the-windowed-algorithm">Walking Through the Windowed Algorithm</a></li>
  <li><a href="#comparing-single-pass-vs-windowed" id="toc-comparing-single-pass-vs-windowed" class="nav-link" data-scroll-target="#comparing-single-pass-vs-windowed">Comparing Single-Pass vs Windowed</a></li>
  </ul></li>
  <li><a href="#system-design-integration" id="toc-system-design-integration" class="nav-link" data-scroll-target="#system-design-integration">System Design Integration</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  <li><a href="#references-further-reading" id="toc-references-further-reading" class="nav-link" data-scroll-target="#references-further-reading">References &amp; Further Reading</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/aayushmnit/aayushmnit.github.io/blob/main/posts/2025-12-28-DiversityDPPPart2/DiversityDPPPart2.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/aayushmnit/aayushmnit.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Diversity in Recommendations - Determinantal Point Processes (DPP)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Recommender System</div>
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">Diversity</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aayush Agrawal </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>Part 2 of the diversity series: Moving from greedy MMR to principled probabilistic frameworks with DPPs</p>
</blockquote>
<figure align="center" class="figure">
<img src="./dpp_infographic.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure: DPP infographic. Credit: <a href="https://notebooklm.google.com/">NotebookLM</a>
</figcaption>
</figure>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Disclaimer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>The views expressed in this blog are solely my own and are not affiliated with my employer in any way. In writing this, I have not utilized any proprietary or confidential information.</p>
</div>
</div>
</div>
<p>In <a href="https://aayushmnit.com/posts/2025-12-25-DiversityMMRPart1/DiversityMMRPart1.html">previous blog</a>, we explored MMR as a practical way to inject diversity into recommendation results. MMR works well, but it has a fundamental limitation: it’s greedy and myopic. At each step, it only considers similarity to items <em>already selected</em>, not the global structure of the final set.</p>
<p>What if we could evaluate the diversity of an <em>entire set</em> at once? That’s exactly what Determinantal Point Processes (DPPs) offer. DPPs come from probability theory and give us a principled way to assign higher probability to sets of items that are both high-quality and diverse. For example, MMR might select two sci-fi thrillers that individually seem distinct from other picks, but together make the final set feel repetitive. DPPs evaluate the whole set at once, catching this overlap.</p>
<p>In this post, we’ll:</p>
<ul>
<li>Build geometric intuition for DPPs through determinants as volume</li>
<li>Understand the quality-diversity decomposition for production systems</li>
<li>Implement greedy MAP inference step-by-step</li>
<li>Explore YouTube’s production approach with tunable parameters (α, σ)</li>
<li>Walk through the windowed algorithm for ranking entire feeds</li>
<li>Compare DPP and MMR on our video recommendation example</li>
</ul>
<section id="linear-algebra-refresher-determinants-as-volume" class="level1">
<h1>Linear Algebra Refresher: Determinants as Volume</h1>
<figure align="center" class="figure">
<img src="./dpp_intuition.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure: Mathematical Intuition behind DPP. Credit: <a href="https://notebooklm.google.com/">NotebookLM</a>
</figcaption>
</figure>
<p>Before diving into DPPs, we need to refresh one key concept: <strong>determinants measure volume</strong>.</p>
<p>Consider two vectors in 2D space. The determinant of the matrix formed by these vectors equals the area of the parallelogram they span.</p>
<div id="cell-8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:11:30.016877Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:11:30.014331Z&quot;}}" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:11:45.146018Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:11:45.141973Z&quot;}}" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two similar vectors (small area)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>v1 <span class="op">=</span> np.array([<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>v2 <span class="op">=</span> np.array([<span class="fl">0.9</span>, <span class="fl">0.1</span>])</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>similar_matrix <span class="op">=</span> np.array([v1, v2])</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Similar vectors determinant: </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>det(similar_matrix)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Two orthogonal vectors (maximum area)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>v1 <span class="op">=</span> np.array([<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>v2 <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>diverse_matrix <span class="op">=</span> np.array([v1, v2])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Orthogonal vectors determinant: </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>det(diverse_matrix)<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Similar vectors determinant: 0.100
Orthogonal vectors determinant: 1.000</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:11:43.211051Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:11:42.758865Z&quot;}}" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_parallelogram(ax, v1, v2, title, det_val):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    v1, v2 <span class="op">=</span> np.array(v1), np.array(v2)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot parallelogram</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    vertices <span class="op">=</span> np.array([[<span class="dv">0</span>, <span class="dv">0</span>], v1, v1 <span class="op">+</span> v2, v2, [<span class="dv">0</span>, <span class="dv">0</span>]])</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    ax.fill(vertices[:, <span class="dv">0</span>], vertices[:, <span class="dv">1</span>], alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(vertices[:, <span class="dv">0</span>], vertices[:, <span class="dv">1</span>], <span class="st">'b-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot vectors as arrows</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    ax.annotate(<span class="st">''</span>, xy<span class="op">=</span>v1, xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>), arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'red'</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ax.annotate(<span class="st">''</span>, xy<span class="op">=</span>v2, xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>), arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'green'</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="op">-</span><span class="fl">0.2</span>, <span class="fl">2.0</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="op">-</span><span class="fl">0.2</span>, <span class="fl">1.2</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title<span class="sc">}</span><span class="ch">\n</span><span class="ss">det = </span><span class="sc">{</span>det_val<span class="sc">:.2f}</span><span class="ss"> (area)"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'x'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'y'</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Similar vectors</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>plot_parallelogram(axes[<span class="dv">0</span>], [<span class="dv">1</span>, <span class="dv">0</span>], [<span class="fl">0.9</span>, <span class="fl">0.1</span>], <span class="st">"Similar Vectors"</span>, <span class="fl">0.1</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Orthogonal vectors  </span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>plot_parallelogram(axes[<span class="dv">1</span>], [<span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">"Orthogonal Vectors"</span>, <span class="fl">1.0</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'determinant_volume.png'</span>, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DiversityDPPPart2_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This is the geometric intuition behind DPPs: <strong>diverse sets span more volume, giving them higher determinants</strong>. When vectors point in similar directions, they span a thin, squashed parallelogram. When they’re spread out, the volume is large.</p>
<p>This extends to higher dimensions. For <em>k</em> vectors in <em>d</em>-dimensional space, the determinant of their Gram matrix (<code>L = VVᵀ</code>) measures the squared volume of the k-dimensional parallelotope they span.</p>
<p>Note: Gram matrix is also called the “kernel matrix” in <a href="https://arxiv.org/abs/1207.6083">DPP literature</a>.</p>
<div id="cell-12" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:12:02.317116Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:12:02.302958Z&quot;}}" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 items in 3D feature space</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>items <span class="op">=</span> np.array([</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>],    <span class="co"># Item A</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],    <span class="co"># Item B  </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>],    <span class="co"># Item C (diverse from A, B)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> items <span class="op">@</span> items.T  <span class="co"># Gram matrix</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Diverse set det(L): </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>det(L)<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace C with something similar to A</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>items_similar <span class="op">=</span> np.array([</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>],      <span class="co"># Item A</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],      <span class="co"># Item B</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>],  <span class="co"># Item C' (similar to A)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>L_similar <span class="op">=</span> items_similar <span class="op">@</span> items_similar.T</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Similar set det(L): </span><span class="sc">{</span>np<span class="sc">.</span>linalg<span class="sc">.</span>det(L_similar)<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Diverse set det(L): 1.000
Similar set det(L): 0.010</code></pre>
</div>
</div>
<p>The diverse set has 100x higher determinant. This is the core of DPPs: <strong>recommendation probability proportional to determinant means diverse sets are exponentially more likely</strong>.</p>
</section>
<section id="dpp-fundamentals-from-volume-to-probability" class="level1">
<h1>DPP Fundamentals: From Volume to Probability</h1>
<p>Now we can define what a DPP actually is. Given a ground set of N items (our candidate pool), a DPP defines a probability distribution over all possible subsets. The key formula is:</p>
<p><code>P(Y) ∝ det(L_Y)</code></p>
<p>where:</p>
<ul>
<li><code>Y</code> is a subset of items we might recommend</li>
<li><code>L</code> is an N×N positive semi-definite kernel matrix capturing item relationships</li>
<li><code>L_Y</code> is the submatrix of <code>L</code> indexed by items in <code>Y</code></li>
</ul>
<p>The probability of selecting a set is proportional to the determinant of its kernel submatrix. From our linear algebra refresher, we know determinants measure volume, so <strong>diverse sets that span more volume get higher probability</strong>.</p>
<p>Let’s use the same video recommendation example from Part 1:</p>
<div id="cell-16" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:13:10.855574Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:13:10.850690Z&quot;}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>relevance <span class="op">=</span> np.array([<span class="fl">0.9</span>, <span class="fl">0.85</span>, <span class="fl">0.8</span>, <span class="fl">0.7</span>, <span class="fl">0.6</span>, <span class="fl">0.5</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>genre <span class="op">=</span> [<span class="st">'Action'</span>, <span class="st">'Action'</span>, <span class="st">'Action'</span>, <span class="st">'Comedy'</span>, <span class="st">'Documentary'</span>, <span class="st">'Mixed comedy/documentary'</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> np.array([</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">1.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>],   <span class="co"># video 0: pure action</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.9</span>, <span class="fl">0.1</span>, <span class="fl">0.0</span>],   <span class="co"># video 1: action (very similar to 0)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>],   <span class="co"># video 2: action (also very similar to 0)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>],   <span class="co"># video 3: comedy</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>],   <span class="co"># video 4: documentary</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>],   <span class="co"># video 5: mixed</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Build kernel matrix L = VVᵀ (Gram matrix from embeddings)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> embeddings <span class="op">@</span> embeddings.T</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Kernel matrix L:"</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(L, <span class="dv">2</span>))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Similarity of video 0 (</span><span class="sc">{</span>genre[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">), with other videos"</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="bu">len</span>(genre)):</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Video </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>L[<span class="dv">0</span>][i]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[i]<span class="sc">}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Kernel matrix L:
[[1.   0.9  0.8  0.   0.   0.1 ]
 [0.9  0.82 0.73 0.1  0.   0.14]
 [0.8  0.73 0.66 0.1  0.1  0.18]
 [0.   0.1  0.1  1.   0.   0.5 ]
 [0.   0.   0.1  0.   1.   0.5 ]
 [0.1  0.14 0.18 0.5  0.5  0.51]]

Similarity of video 0 (Action), with other videos
Video 1: 0.9 (Action)
Video 2: 0.8 (Action)
Video 3: 0.0 (Comedy)
Video 4: 0.0 (Documentary)
Video 5: 0.1 (Mixed comedy/documentary)</code></pre>
</div>
</div>
<p>Notice how videos 0, 1, 2 (all Action) have high similarity (~0.8-0.9), while Action vs Comedy is 0. Now let’s compare the DPP probability of two different 3-video sets:</p>
<div id="cell-18" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:13:14.485085Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:13:14.480201Z&quot;}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> subset_det(L, indices):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute det(L_Y) for a subset of indices"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    L_Y <span class="op">=</span> L[np.ix_(indices, indices)]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.linalg.det(L_Y)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Set 1: Three action videos (redundant)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>redundant <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]  <span class="co"># Action, Action, Action</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>det_redundant <span class="op">=</span> subset_det(L, redundant)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Redundant set: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> redundant]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  det(L_Y) = </span><span class="sc">{</span>det_redundant<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Set 2: Action + Comedy + Documentary (diverse)</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>diverse <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>]</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>det_diverse <span class="op">=</span> subset_det(L, diverse)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Diverse set: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> diverse]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  det(L_Y) = </span><span class="sc">{</span>det_diverse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Diverse set is </span><span class="sc">{</span>det_diverse<span class="op">/</span>det_redundant<span class="sc">:.0f}</span><span class="ss">x more likely under DPP"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Redundant set: ['Action', 'Action', 'Action']
  det(L_Y) = 0.0001

Diverse set: ['Action', 'Comedy', 'Documentary']
  det(L_Y) = 1.0000

Diverse set is 10000x more likely under DPP</code></pre>
</div>
</div>
<p>The diverse set spanning Action, Comedy, and Documentary is <strong>10000x more likely</strong> than picking three similar action videos! This is the DPP magic: it naturally penalizes redundancy by evaluating the entire set at once, rather than making greedy pairwise comparisons like MMR.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Why L(Kernel Matrix) needs to be Positive Semi-Definite (PSD)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>L needs to be <strong>positive semi-definite (PSD)</strong>. Practically, this means:</p>
<ol type="1">
<li>All eigenvalues are ≥ 0</li>
<li>Determinants of all submatrices are ≥ 0 (which we need for valid probabilities!)</li>
</ol>
<p><strong>Why DPPs require PSD</strong>: Since <code>P(Y) ∝ det(L_Y)</code>, we need <code>det(L_Y)</code> ≥ 0 for all subsets. PSD guarantees this.</p>
<p><strong>Good news for practitioners</strong>: When you build L = VVᵀ (Gram matrix from embeddings), it’s <em>automatically</em> PSD. So as long as you construct your kernel matrix as L = VVᵀ (or use standard similarity kernels like RBF), you’re safe. You only run into trouble if you manually construct L with arbitrary values.</p>
</div>
</div>
</div>
</section>
<section id="quality-vs-diversity-decomposition" class="level1">
<h1>Quality vs Diversity Decomposition</h1>
<figure align="center" class="figure">
<img src="./quality_diversity_tradeoff.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure: Quality diversity tradeoff in DPP. Credit: <a href="https://notebooklm.google.com/">NotebookLM</a>
</figcaption>
</figure>
<p>So far our kernel matrix L only captures similarity between items. But in real recommendations, we care about <em>both</em> quality (relevance) and diversity. A diverse set of low-quality items is useless.</p>
<p>DPPs handle this elegantly through the <strong>quality-diversity decomposition</strong>:</p>
<p><code>L[i,j] = q_i × q_j × S[i,j]</code></p>
<p>where:</p>
<ul>
<li><code>q_i</code> is the quality (relevance) score for item i</li>
<li><code>S[i,j]</code> is the similarity between items i and j (from embeddings)</li>
</ul>
<p>This decomposes naturally: diagonal entries <code>L[i,i] = q_i²</code> capture item quality, while off-diagonal entries capture similarity scaled by both items’ quality. High-quality similar items create larger off-diagonal terms, which <em>reduce</em> the determinant (penalizing redundancy among your best items).</p>
<p>Let’s rebuild our kernel matrix with relevance scores:</p>
<div id="cell-24" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:19:10.603129Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:19:10.599303Z&quot;}}" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Similarity matrix from embeddings</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> embeddings <span class="op">@</span> embeddings.T</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Quality-weighted kernel: L[i,j] = q_i * q_j * S[i,j]</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> relevance.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># Column vector</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>L_quality <span class="op">=</span> (q <span class="op">@</span> q.T) <span class="op">*</span> S</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Quality-weighted kernel L:"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(L_quality, <span class="dv">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Quality-weighted kernel L:
[[0.81  0.688 0.576 0.    0.    0.045]
 [0.688 0.592 0.496 0.06  0.    0.06 ]
 [0.576 0.496 0.422 0.056 0.048 0.072]
 [0.    0.06  0.056 0.49  0.    0.175]
 [0.    0.    0.048 0.    0.36  0.15 ]
 [0.045 0.06  0.072 0.175 0.15  0.128]]</code></pre>
</div>
</div>
<p>Let’s compare the two sets again with the new kernel matrix:</p>
<div id="cell-26" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:19:15.771601Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:19:15.767381Z&quot;}}" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>redundant <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]  <span class="co"># Top 3 by relevance, all Action</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>diverse <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>]    <span class="co"># Action + Comedy + Documentary</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>det_redundant <span class="op">=</span> subset_det(L_quality, redundant)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>det_diverse <span class="op">=</span> subset_det(L_quality, diverse)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Redundant set (top-3 relevance): </span><span class="sc">{</span>[<span class="ss">f'</span><span class="sc">{</span>genre[i]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>relevance[i]<span class="sc">}</span><span class="ss">)'</span> <span class="cf">for</span> i <span class="kw">in</span> redundant]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" det = </span><span class="sc">{</span>det_redundant<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Diverse set (mixed relevance): </span><span class="sc">{</span>[<span class="ss">f'</span><span class="sc">{</span>genre[i]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>relevance[i]<span class="sc">}</span><span class="ss">)'</span> <span class="cf">for</span> i <span class="kw">in</span> diverse]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" det = </span><span class="sc">{</span>det_diverse<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Diverse set is </span><span class="sc">{</span>det_diverse<span class="op">/</span>det_redundant<span class="sc">:.0f}</span><span class="ss">x more likely"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Redundant set (top-3 relevance): ['Action (0.9)', 'Action (0.85)', 'Action (0.8)']
 det = 0.000037

Diverse set (mixed relevance): ['Action (0.9)', 'Comedy (0.7)', 'Documentary (0.6)']
 det = 0.142884

Diverse set is 3815x more likely</code></pre>
</div>
</div>
<p>Even though the diverse set includes lower-relevance items (0.7, 0.6 vs 0.85, 0.8), the diversity bonus from spanning different genres still makes it far more probable (3815x as compared to 10000x before). The quality weighting ensures we don’t pick diverse but irrelevant items.</p>
<p><strong>The intuition</strong>: Think of <code>q_i</code> as the “length” of item i’s feature vector. The determinant measures the volume spanned by these vectors. A high-quality item contributes a longer vector, but if two long vectors point in the same direction (similar items), the parallelogram is still flat. You need both length (quality) AND spread (diversity) to maximize volume.</p>
<div id="cell-28" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:20:43.026376Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:20:42.603316Z&quot;}}" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">4</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Case 1: Short vectors, diverse directions</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>plot_parallelogram(axes[<span class="dv">0</span>], [<span class="fl">0.5</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="fl">0.5</span>], </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Low Quality, High Diversity</span><span class="ch">\n</span><span class="st">Short vectors, spread out"</span>, <span class="fl">0.25</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Case 2: Long vectors, similar directions  </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plot_parallelogram(axes[<span class="dv">1</span>], [<span class="fl">1.0</span>, <span class="dv">0</span>], [<span class="fl">0.9</span>, <span class="fl">0.1</span>],</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High Quality, Low Diversity</span><span class="ch">\n</span><span class="st">Long vectors, same direction"</span>, <span class="fl">0.10</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Case 3: Long vectors, diverse directions (ideal)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plot_parallelogram(axes[<span class="dv">2</span>], [<span class="fl">1.0</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="fl">1.0</span>],</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High Quality, High Diversity</span><span class="ch">\n</span><span class="st">Long vectors, spread out"</span>, <span class="fl">1.00</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'quality_diversity_volume.png'</span>, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DiversityDPPPart2_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This maps directly to production recsys:</p>
<ul>
<li><code>q_i</code> = your relevance model output (e.g., predicted click probability)</li>
<li><code>S[i,j]</code> = Similarity of content embeddings (or 1 - distance in any embedding space)</li>
<li><code>L</code> = the kernel that balances both signals</li>
</ul>
</section>
<section id="greedy-map-the-practical-dpp-algorithm" class="level1">
<h1>Greedy MAP: The Practical DPP Algorithm</h1>
<p>We’ve established that DPPs assign higher probability to diverse, high-quality sets via determinants. The natural question: how do we find the best set?</p>
<p><strong>The challenge</strong>: Finding the subset <code>Y</code> that maximizes <code>det(L_Y)</code> is called <strong>MAP (Maximum A Posteriori) inference</strong>. With N candidates, there are <code>2^N</code> possible subsets. This is NP-hard in general.</p>
<p><strong>The solution</strong>: <strong>Greedy MAP approximation</strong>. Build the set one item at a time, always adding whichever item increases the determinant most. This runs in <code>O(Nk³)</code> time and provides provably good approximations, where N is the number of candidates to select from and k is the number of items to select.</p>
<section id="walking-through-greedy-map-step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="walking-through-greedy-map-step-by-step">Walking Through Greedy MAP Step-by-Step</h2>
<p>Let’s trace through selecting 3 videos from our candidate pool. At each step, we try adding every remaining candidate and pick whoever maximizes <code>det(L_Y)</code>.</p>
<p><strong>Step 1: First Selection</strong></p>
<p>With an empty set, we’re just comparing single-item determinants. For a 1×1 matrix, <code>det([L[i,i]]) = L[i,i] = q_i²</code>. So the first pick is simply the highest-quality item:</p>
<div id="cell-34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:30:32.148910Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:30:32.144453Z&quot;}}" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Step 1: Evaluating single-item determinants (= quality squared)"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance)):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    det_single <span class="op">=</span> L_quality[i, i]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Video </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[i]<span class="sc">}</span><span class="ss">): det = </span><span class="sc">{</span>det_single<span class="sc">:.3f}</span><span class="ss"> (relevance² = </span><span class="sc">{</span>relevance[i]<span class="op">**</span><span class="dv">2</span><span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>first_pick <span class="op">=</span> <span class="bu">int</span>(np.argmax([L_quality[i,i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance))]))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">→ Select video </span><span class="sc">{</span>first_pick<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[first_pick]<span class="sc">}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step 1: Evaluating single-item determinants (= quality squared)
  Video 0 (Action): det = 0.810 (relevance² = 0.810)
  Video 1 (Action): det = 0.592 (relevance² = 0.722)
  Video 2 (Action): det = 0.422 (relevance² = 0.640)
  Video 3 (Comedy): det = 0.490 (relevance² = 0.490)
  Video 4 (Documentary): det = 0.360 (relevance² = 0.360)
  Video 5 (Mixed comedy/documentary): det = 0.128 (relevance² = 0.250)

→ Select video 0 (Action)</code></pre>
</div>
</div>
<p><strong>Step 2: Second Selection</strong></p>
<p>Now it gets interesting. We evaluate each remaining candidate by computing <code>det(L_Y)</code> for the 2-item set:</p>
<div id="cell-36" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:30:34.381727Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:30:34.376166Z&quot;}}" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>selected <span class="op">=</span> [first_pick]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Step 2: Current set = [Video </span><span class="sc">{</span>first_pick<span class="sc">}</span><span class="ss">]"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Evaluating candidates:"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> candidate <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance)):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> candidate <span class="kw">in</span> selected:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> selected <span class="op">+</span> [candidate]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    L_subset <span class="op">=</span> L_quality[np.ix_(subset, subset)]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    det_val <span class="op">=</span> np.linalg.det(L_subset)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show the 2x2 matrix being evaluated</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Video </span><span class="sc">{</span>candidate<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[candidate]<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    L_subset = [[</span><span class="sc">{</span>L_subset[<span class="dv">0</span>,<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>L_subset[<span class="dv">0</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">],"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"                [</span><span class="sc">{</span>L_subset[<span class="dv">1</span>,<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, </span><span class="sc">{</span>L_subset[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">]]"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"    det = </span><span class="sc">{</span>L_subset[<span class="dv">0</span>,<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> × </span><span class="sc">{</span>L_subset[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss"> - </span><span class="sc">{</span>L_subset[<span class="dv">0</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss"> × </span><span class="sc">{</span>L_subset[<span class="dv">1</span>,<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss"> = </span><span class="sc">{</span>det_val<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step 2: Current set = [Video 0]
Evaluating candidates:

  Video 1 (Action):
    L_subset = [[0.810, 0.689],
                [0.689, 0.592]]
    det = 0.810 × 0.592 - 0.689 × 0.689 = 0.0059

  Video 2 (Action):
    L_subset = [[0.810, 0.576],
                [0.576, 0.422]]
    det = 0.810 × 0.422 - 0.576 × 0.576 = 0.0104

  Video 3 (Comedy):
    L_subset = [[0.810, 0.000],
                [0.000, 0.490]]
    det = 0.810 × 0.490 - 0.000 × 0.000 = 0.3969

  Video 4 (Documentary):
    L_subset = [[0.810, 0.000],
                [0.000, 0.360]]
    det = 0.810 × 0.360 - 0.000 × 0.000 = 0.2916

  Video 5 (Mixed comedy/documentary):
    L_subset = [[0.810, 0.045],
                [0.045, 0.128]]
    det = 0.810 × 0.128 - 0.045 × 0.045 = 0.1013</code></pre>
</div>
</div>
<p>Notice how adding another Action video (high off-diagonal similarity) leads to a lower determinant, while Comedy or Documentary (zero similarity to Action) leads to a higher determinant. In this case we will pick Video 3 as it has the highest determinant of <code>0.3969</code>.</p>
<div id="cell-38" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:30:36.288683Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:30:36.284187Z&quot;}}" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find second pick</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>best_det, second_pick <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, <span class="va">None</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> candidate <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance)):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> candidate <span class="kw">in</span> selected:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> selected <span class="op">+</span> [candidate]</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    det_val <span class="op">=</span> np.linalg.det(L_quality[np.ix_(subset, subset)])</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> det_val <span class="op">&gt;</span> best_det:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        best_det, second_pick <span class="op">=</span> det_val, candidate</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">→ Select video </span><span class="sc">{</span>second_pick<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[second_pick]<span class="sc">}</span><span class="ss">), det = </span><span class="sc">{</span>best_det<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>selected.append(second_pick)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
→ Select video 3 (Comedy), det = 0.3969</code></pre>
</div>
</div>
<p><strong>Step 3: Third Selection</strong></p>
<p>Same process with a 3×3 determinant:</p>
<div id="cell-40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:30:40.753920Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:30:40.748612Z&quot;}}" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Step 3: Current set = </span><span class="sc">{</span>selected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Evaluating candidates:"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> candidate <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance)):</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> candidate <span class="kw">in</span> selected:</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> selected <span class="op">+</span> [candidate]</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    det_val <span class="op">=</span> np.linalg.det(L_quality[np.ix_(subset, subset)])</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Video </span><span class="sc">{</span>candidate<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[candidate]<span class="sc">}</span><span class="ss">): det = </span><span class="sc">{</span>det_val<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Find third pick</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>best_det, third_pick <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, <span class="va">None</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> candidate <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(relevance)):</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> candidate <span class="kw">in</span> selected:</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> selected <span class="op">+</span> [candidate]</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    det_val <span class="op">=</span> np.linalg.det(L_quality[np.ix_(subset, subset)])</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> det_val <span class="op">&gt;</span> best_det:</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        best_det, third_pick <span class="op">=</span> det_val, candidate</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>selected.append(third_pick)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">→ Select video </span><span class="sc">{</span>third_pick<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>genre[third_pick]<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final selection: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> selected]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Step 3: Current set = [0, 3]
Evaluating candidates:
  Video 1 (Action): det = 0.0000
  Video 2 (Action): det = 0.0025
  Video 4 (Documentary): det = 0.1429
  Video 5 (Mixed comedy/documentary): det = 0.0248

→ Select video 4 (Documentary)

Final selection: ['Action', 'Comedy', 'Documentary']</code></pre>
</div>
</div>
</section>
<section id="the-complete-implementation" class="level2">
<h2 class="anchored" data-anchor-id="the-complete-implementation">The Complete Implementation</h2>
<p>Now we can wrap this into a clean function:</p>
<div id="cell-43" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:26:05.953919Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:26:05.947994Z&quot;}}" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greedy_map_dpp(L, k):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> L.shape[<span class="dv">0</span>]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    selected <span class="op">=</span> []</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="bu">set</span>(<span class="bu">range</span>(N))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(k):</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        best_item, best_det <span class="op">=</span> <span class="va">None</span>, <span class="op">-</span><span class="dv">1</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> remaining:</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>            candidate_set <span class="op">=</span> selected <span class="op">+</span> [item]</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            det_val <span class="op">=</span> np.linalg.det(L[np.ix_(candidate_set, candidate_set)])</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> det_val <span class="op">&gt;</span> best_det:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>                best_det <span class="op">=</span> det_val</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                best_item <span class="op">=</span> item</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        selected.append(best_item)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        remaining.remove(best_item)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> selected</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run it</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> greedy_map_dpp(L_quality, k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Greedy MAP result: </span><span class="sc">{</span>[<span class="ss">f'</span><span class="sc">{</span>genre[i]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>relevance[i]<span class="sc">}</span><span class="ss">)'</span> <span class="cf">for</span> i <span class="kw">in</span> result]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Greedy MAP result: ['Action (0.9)', 'Comedy (0.7)', 'Documentary (0.6)']</code></pre>
</div>
</div>
<p>Pure relevance ranking would give us Action, Action, Action. DPP gives us Action, Comedy, Documentary. Three genres covered in three slots.</p>
</section>
</section>
<section id="tuning-the-quality-diversity-tradeoff" class="level1">
<h1>Tuning the Quality-Diversity Tradeoff</h1>
<figure align="center" class="figure">
<img src="./dpps_in_production.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure: Youtube’s DPP Implementation. Credit: <a href="https://notebooklm.google.com/">NotebookLM</a>
</figcaption>
</figure>
<p>In production, you need a way to control how much the system emphasizes relevance versus diversity. YouTube’s approach, described in their <a href="https://dl.acm.org/doi/epdf/10.1145/3269206.3272018">2018 paper on DPPs for recommendations</a>, provides a clean parameterization that’s proven to work at scale.</p>
<section id="youtubes-kernel-parameterization" class="level2">
<h2 class="anchored" data-anchor-id="youtubes-kernel-parameterization">YouTube’s Kernel Parameterization</h2>
<figure align="center" class="figure">
<img src="./kernel_formula_dpp.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure 2: Snapshot of DPP kenel matrix formulation from <a href="https://dl.acm.org/doi/epdf/10.1145/3269206.3272018">YT DPP paper</a>
</figcaption>
</figure>
<p>Instead of the simple <code>L[i,j] = q_i × q_j × S[i,j]</code> formulation, YouTube uses:</p>
<p><code>L[i,i] = q_i²</code> (diagonal: quality squared)</p>
<p><code>L[i,j] = α × q_i × q_j × exp(-D_ij / 2σ²)</code> for <code>i ≠ j</code> (off-diagonal: scaled similarity)</p>
<p>where:</p>
<ul>
<li><code>q_i</code> is the relevance score for item i</li>
<li><code>D_ij</code> is the distance between items i and j in embedding space</li>
<li><code>α</code> controls the overall strength of diversity (0 ≤ α ≤ 1)</li>
<li><code>σ</code> controls the length scale of similarity</li>
</ul>
<p><strong>The key insight</strong>: The diagonal entries (quality) remain unchanged, but off-diagonal entries (similarity) are scaled by α. This gives you direct control over the diversity penalty.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Note: This formulation is identical to a standard (Gaussian) radial basis function (RBF) kernel when α = 1.</p>
</div>
</div>
</div>
</section>
<section id="understanding-the-parameters" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-parameters">Understanding the Parameters</h2>
<p><strong>α (diversity strength)</strong>:</p>
<ul>
<li>α = 1: Full diversity penalty. Similar items strongly repel each other.</li>
<li>α = 0: No diversity penalty. Reduces to pure relevance ranking.</li>
<li>α ∈ (0,1): Smooth tradeoff between quality and diversity.</li>
</ul>
<p><strong>σ (similarity scale)</strong>:</p>
<ul>
<li>Small σ: Only very similar items are considered redundant (tight clusters).</li>
<li>Large σ: Even moderately different items are penalized (broad diversity).</li>
</ul>
<p>Let’s implement this new kernel building function:</p>
<div id="cell-54" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:35:50.325644Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:35:50.320650Z&quot;}}" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> youtube_dpp_kernel(relevance, embeddings, alpha<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> <span class="bu">len</span>(relevance)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> np.zeros((N, N))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute pairwise distances</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># D_ij = ||embedding_i - embedding_j||²</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Diagonal: quality squared</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                L[i, i] <span class="op">=</span> relevance[i] <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Off-diagonal: scaled similarity with RBF kernel</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                D_ij <span class="op">=</span> np.<span class="bu">sum</span>((embeddings[i] <span class="op">-</span> embeddings[j]) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                similarity <span class="op">=</span> np.exp(<span class="op">-</span>D_ij <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                L[i, j] <span class="op">=</span> alpha <span class="op">*</span> relevance[i] <span class="op">*</span> relevance[j] <span class="op">*</span> similarity</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Build kernel with YouTube's approach</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>L_youtube <span class="op">=</span> youtube_dpp_kernel(relevance, embeddings, alpha<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"YouTube DPP kernel (α=0.5, σ=1.0):"</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(np.<span class="bu">round</span>(L_youtube, <span class="dv">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>YouTube DPP kernel (α=0.5, σ=1.0):
[[0.81  0.379 0.349 0.116 0.099 0.117]
 [0.379 0.722 0.337 0.132 0.103 0.126]
 [0.349 0.337 0.64  0.135 0.116 0.133]
 [0.116 0.132 0.135 0.49  0.077 0.136]
 [0.099 0.103 0.116 0.077 0.36  0.116]
 [0.117 0.126 0.133 0.136 0.116 0.25 ]]</code></pre>
</div>
</div>
</section>
<section id="sweeping-the-α-parameter" class="level2">
<h2 class="anchored" data-anchor-id="sweeping-the-α-parameter">Sweeping the α Parameter</h2>
<p>Let’s see how α affects the diversity-quality tradeoff:</p>
<div id="cell-57" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:42:16.571002Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:42:16.561467Z&quot;}}" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">α parameter sweep (σ=1.0 fixed):"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'α'</span><span class="sc">:&lt;6}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Selected Items'</span><span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Genres'</span><span class="sc">:&lt;40}</span><span class="ss">"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">95</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>alphas <span class="op">=</span> [<span class="fl">0.0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1.0</span>]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    L_alpha <span class="op">=</span> youtube_dpp_kernel(relevance, embeddings, alpha<span class="op">=</span>alpha, sigma<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    selected <span class="op">=</span> greedy_map_dpp(L_alpha, k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    items_str <span class="op">=</span> <span class="st">", "</span>.join([<span class="ss">f"V</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>relevance[i]<span class="sc">:.2f}</span><span class="ss">)"</span> <span class="cf">for</span> i <span class="kw">in</span> selected])</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    genres_str <span class="op">=</span> <span class="st">", "</span>.join([genre[i] <span class="cf">for</span> i <span class="kw">in</span> selected])</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>alpha<span class="sc">:&lt;6.2f}</span><span class="ss"> </span><span class="sc">{</span>items_str<span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span>genres_str<span class="sc">:&lt;40}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
α parameter sweep (σ=1.0 fixed):
α      Selected Items                                     Genres                                  
-----------------------------------------------------------------------------------------------
0.00   V0(0.90), V1(0.85), V2(0.80)                       Action, Action, Action                  
0.25   V0(0.90), V1(0.85), V2(0.80)                       Action, Action, Action                  
0.50   V0(0.90), V1(0.85), V3(0.70)                       Action, Action, Comedy                  
0.75   V0(0.90), V3(0.70), V4(0.60)                       Action, Comedy, Documentary             
1.00   V0(0.90), V3(0.70), V4(0.60)                       Action, Comedy, Documentary             </code></pre>
</div>
</div>
<p><strong>Key observations</strong>:</p>
<ul>
<li><strong>α = 0.0–0.25</strong>: Pure relevance ranking. Off-diagonal terms are too weak to overcome quality differences, so we get the top-3 by relevance (all Action).</li>
<li><strong>α = 0.5</strong>: Moderate diversity kicks in. The algorithm trades Video 2 (Action, 0.80) for Video 3 (Comedy, 0.70), accepting a small relevance drop for genre diversity.</li>
<li><strong>α = 0.75–1.0</strong>: Strong diversity preference. The algorithm maximizes spread across genres (Action, Comedy, Documentary), dropping Video 1 (Action, 0.85) in favor of lower-relevance items from different genres.</li>
</ul>
<p>The transition happens around α = 0.5, where the diversity penalty becomes strong enough to outweigh small relevance differences. In production, you’d tune α based on metrics like session diversity, user engagement, or A/B test results.</p>
</section>
<section id="sweeping-the-σ-parameter" class="level2">
<h2 class="anchored" data-anchor-id="sweeping-the-σ-parameter">Sweeping the σ Parameter</h2>
<p>The σ parameter controls what counts as “similar”. Let’s fix α = 0.75 and vary σ:</p>
<div id="cell-61" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:42:10.634474Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:42:10.625461Z&quot;}}" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">σ parameter sweep (α=0.75 fixed):"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'σ'</span><span class="sc">:&lt;6}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Selected Items'</span><span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Genres'</span><span class="sc">:&lt;40}</span><span class="ss">"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">95</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>sigmas <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">5.0</span>]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sigma <span class="kw">in</span> sigmas:</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    L_sigma <span class="op">=</span> youtube_dpp_kernel(relevance, embeddings, alpha<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span>sigma)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    selected <span class="op">=</span> greedy_map_dpp(L_sigma, k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    items_str <span class="op">=</span> <span class="st">", "</span>.join([<span class="ss">f"V</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>relevance[i]<span class="sc">:.2f}</span><span class="ss">)"</span> <span class="cf">for</span> i <span class="kw">in</span> selected])</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    genres_str <span class="op">=</span> <span class="st">", "</span>.join([genre[i] <span class="cf">for</span> i <span class="kw">in</span> selected])</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>sigma<span class="sc">:&lt;6.1f}</span><span class="ss"> </span><span class="sc">{</span>items_str<span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span>genres_str<span class="sc">:&lt;40}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
σ parameter sweep (α=0.75 fixed):
σ      Selected Items                                     Genres                                  
-----------------------------------------------------------------------------------------------
0.1    V0(0.90), V1(0.85), V2(0.80)                       Action, Action, Action                  
0.5    V0(0.90), V3(0.70), V4(0.60)                       Action, Comedy, Documentary             
1.0    V0(0.90), V3(0.70), V4(0.60)                       Action, Comedy, Documentary             
2.0    V0(0.90), V3(0.70), V1(0.85)                       Action, Comedy, Action                  
5.0    V0(0.90), V1(0.85), V2(0.80)                       Action, Action, Action                  </code></pre>
</div>
</div>
<p><strong>Key observations</strong>:</p>
<ul>
<li><strong>σ = 0.1</strong>: Very tight similarity threshold. Only near-identical items are penalized as redundant, so the diversity effect barely activates. Result: top-3 by relevance (all Action).</li>
<li><strong>σ = 0.5–1.0</strong>: Moderate similarity scale. Items within the same genre are considered similar enough to penalize, leading to genre mixing (Action, Comedy, Documentary).</li>
<li><strong>σ = 2.0</strong>: Broader similarity scale. Even moderately different items start to look similar. The algorithm becomes more willing to sacrifice relevance for diversity.</li>
<li><strong>σ = 5.0</strong>: Very broad similarity scale. Almost everything looks similar, which actually weakens the diversity signal. The algorithm struggles to distinguish between items and reverts toward relevance-based ranking.</li>
</ul>
<p>In practice, σ should match the natural scale of your embedding space. If your embeddings are normalized (unit length), σ ≈ 1.0 is a reasonable starting point. Tune it based on how strict you want diversity: smaller σ for subtle redundancy detection within tight clusters, larger σ for aggressive spreading across broader categories.</p>
</section>
<section id="visualizing-the-rbf-kernel" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-rbf-kernel">Visualizing the RBF Kernel</h2>
<p>The <code>exp(-D_ij / 2σ²)</code> term is an RBF (Radial Basis Function) kernel. Let’s visualize how it maps distances to similarities:</p>
<div id="cell-65" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:42:26.095856Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:42:25.809480Z&quot;}}" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">100</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sigma <span class="kw">in</span> [<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="fl">2.0</span>]:</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    similarities <span class="op">=</span> np.exp(<span class="op">-</span>distances<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    ax.plot(distances, similarities, label<span class="op">=</span><span class="ss">f'σ=</span><span class="sc">{</span>sigma<span class="sc">}</span><span class="ss">'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Distance D_ij (embedding space)'</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Similarity exp(-D²/2σ²)'</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'RBF Kernel: How Distance Maps to Similarity'</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'rbf_kernel.png'</span>, dpi<span class="op">=</span><span class="dv">150</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="DiversityDPPPart2_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Interpretation</strong>: With σ = 1.0, items at distance 1.0 have similarity ≈ 0.6 (moderate penalty), while items at distance 2.0 have similarity ≈ 0.14 (weak penalty). Smaller σ makes the kernel “sharper” — only very close items are considered similar.</p>
</section>
<section id="practical-guidance" class="level2">
<h2 class="anchored" data-anchor-id="practical-guidance">Practical Guidance</h2>
<p><strong>Tuning strategy</strong>:</p>
<ol type="1">
<li><p><strong>Start with α = 0.5, σ = 1.0</strong>: This is a reasonable default that balances quality and diversity.</p></li>
<li><p><strong>Tune α first</strong>:</p>
<ul>
<li>Sweep α ∈ [0.2, 0.8] in 0.1 increments</li>
<li>Measure offline diversity metrics (intra-list distance, genre entropy) vs relevance metrics (nDCG)</li>
<li>Plot the Pareto frontier to find acceptable tradeoffs</li>
</ul></li>
<li><p><strong>Then tune σ</strong>:</p>
<ul>
<li>If items are still too similar, decrease σ (tighter similarity definition)</li>
<li>If diversity is too aggressive, increase σ (looser similarity definition)</li>
<li>σ should roughly match the typical distance scale in your embedding space</li>
</ul></li>
<li><p><strong>A/B test top candidates</strong>: Run online experiments with 2-3 (α, σ) pairs to validate offline metrics.</p></li>
</ol>
<p><strong>Typical values in production</strong>:</p>
<ul>
<li>Balanced systems: α ≈ 0.4-0.6, σ ≈ 0.5-1.5</li>
<li>Quality-focused (e.g., search): α ≈ 0.2-0.4</li>
<li>Discovery-focused (e.g., explore page): α ≈ 0.6-0.9</li>
</ul>
<p>The beauty of YouTube’s parameterization is that it decouples quality (diagonal) from diversity (off-diagonal), giving you two independent knobs to tune the system behavior.</p>
</section>
</section>
<section id="youtubes-production-dpp-implementation" class="level1">
<h1>YouTube’s Production DPP Implementation</h1>
<p>The greedy MAP algorithm we implemented earlier works well for selecting a fixed top-k set. However, YouTube’s production system needs to rank entire feeds of hundreds or thousands of videos. Their <a href="https://dl.acm.org/doi/epdf/10.1145/3269206.3272018">2018 paper</a> introduces a <strong>windowed approach</strong> that processes candidates in batches, making DPPs scalable for large-scale recommendation systems.</p>
<section id="the-windowed-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="the-windowed-algorithm">The Windowed Algorithm</h2>
<p>Instead of selecting all k items at once from the full candidate pool, YouTube’s algorithm:</p>
<ol type="1">
<li><strong>Selects k items</strong> from the current candidate pool using greedy MAP</li>
<li><strong>Adds them to the result list</strong> R</li>
<li><strong>Removes selected items</strong> from the pool and updates the kernel matrix</li>
<li><strong>Repeats</strong> until all candidates are ranked (or enough items are selected)</li>
</ol>
<p>This approach has several advantages:</p>
<ul>
<li><strong>Scalability</strong>: Processes N items in O(Nk²) time instead of O(Nk³)</li>
<li><strong>Diversity within pages</strong>: Ensures each “window” of k items is diverse, not just the top-k</li>
<li><strong>Memory efficiency</strong>: Can process large pools without computing full N×N kernels</li>
<li><strong>Flexibility</strong>: Can stop early after ranking enough items for the user’s viewport</li>
</ul>
<p>Here’s the algorithm from YouTube’s paper:</p>
<figure align="center" class="figure">
<img src="./yt_dpp.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure 3: Snapshot of DPP algorithm from <a href="https://dl.acm.org/doi/epdf/10.1145/3269206.3272018">YT DPP paper</a>
</figcaption>
</figure>
<div id="cell-74" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:52:10.726285Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:52:10.722300Z&quot;}}" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> youtube_dpp_ranking(relevance, embeddings, k, alpha<span class="op">=</span><span class="fl">0.5</span>, sigma<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(relevance)))  <span class="co"># Remaining candidate indices</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> []  <span class="co"># Final ranked list</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(W) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build kernel for current candidate pool</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        rel_W <span class="op">=</span> relevance[W]</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        emb_W <span class="op">=</span> embeddings[W]</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        L <span class="op">=</span> youtube_dpp_kernel(rel_W, emb_W, alpha<span class="op">=</span>alpha, sigma<span class="op">=</span>sigma)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select up to k items from current pool</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        window_size <span class="op">=</span> <span class="bu">min</span>(k, <span class="bu">len</span>(W))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        M <span class="op">=</span> greedy_map_dpp(L, k<span class="op">=</span>window_size)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map back to original indices</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>        selected_items <span class="op">=</span> [W[i] <span class="cf">for</span> i <span class="kw">in</span> M]</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        R.extend(selected_items)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove selected items from candidate pool</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        W <span class="op">=</span> [w <span class="cf">for</span> w <span class="kw">in</span> W <span class="cf">if</span> w <span class="kw">not</span> <span class="kw">in</span> selected_items]</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> R</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="walking-through-the-windowed-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="walking-through-the-windowed-algorithm">Walking Through the Windowed Algorithm</h2>
<p>Let’s trace through ranking all 6 videos with window size k=2:</p>
<div id="cell-77" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:51:58.607255Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:51:58.599040Z&quot;}}" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"YouTube Windowed DPP (k=2, α=0.75, σ=1.0)"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll manually trace the first few iterations</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(relevance)))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> []</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>k_window <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>alpha, sigma <span class="op">=</span> <span class="fl">0.75</span>, <span class="fl">1.0</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>iteration <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">len</span>(W) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> iteration <span class="op">&lt;=</span> <span class="dv">3</span>:  <span class="co"># Show first 3 iterations</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Iteration </span><span class="sc">{</span>iteration<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Remaining pool W: </span><span class="sc">{</span>W<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Pool genres: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> W]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build kernel for current pool</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    rel_W <span class="op">=</span> relevance[W]</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    emb_W <span class="op">=</span> embeddings[W]</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> youtube_dpp_kernel(rel_W, emb_W, alpha<span class="op">=</span>alpha, sigma<span class="op">=</span>sigma)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select k items</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    window_size <span class="op">=</span> <span class="bu">min</span>(k_window, <span class="bu">len</span>(W))</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> greedy_map_dpp(L, k<span class="op">=</span>window_size)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    selected_items <span class="op">=</span> [W[i] <span class="cf">for</span> i <span class="kw">in</span> M]</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Selected from pool: </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss"> (pool indices)"</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Maps to original: </span><span class="sc">{</span>selected_items<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Genres: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> selected_items]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Relevance: </span><span class="sc">{</span>[relevance[i] <span class="cf">for</span> i <span class="kw">in</span> selected_items]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    R.extend(selected_items)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> [w <span class="cf">for</span> w <span class="kw">in</span> W <span class="cf">if</span> w <span class="kw">not</span> <span class="kw">in</span> selected_items]</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    iteration <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'─'</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final ranking R: </span><span class="sc">{</span>R<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Genres: </span><span class="sc">{</span>[genre[i] <span class="cf">for</span> i <span class="kw">in</span> R]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>YouTube Windowed DPP (k=2, α=0.75, σ=1.0)
======================================================================

Iteration 1:
  Remaining pool W: [0, 1, 2, 3, 4, 5]
  Pool genres: ['Action', 'Action', 'Action', 'Comedy', 'Documentary', 'Mixed comedy/documentary']
  Selected from pool: [0, 3] (pool indices)
  Maps to original: [0, 3]
  Genres: ['Action', 'Comedy']
  Relevance: [np.float64(0.9), np.float64(0.7)]

Iteration 2:
  Remaining pool W: [1, 2, 4, 5]
  Pool genres: ['Action', 'Action', 'Documentary', 'Mixed comedy/documentary']
  Selected from pool: [0, 2] (pool indices)
  Maps to original: [1, 4]
  Genres: ['Action', 'Documentary']
  Relevance: [np.float64(0.85), np.float64(0.6)]

Iteration 3:
  Remaining pool W: [2, 5]
  Pool genres: ['Action', 'Mixed comedy/documentary']
  Selected from pool: [0, 1] (pool indices)
  Maps to original: [2, 5]
  Genres: ['Action', 'Mixed comedy/documentary']
  Relevance: [np.float64(0.8), np.float64(0.5)]

──────────────────────────────────────────────────────────────────────
Final ranking R: [0, 3, 1, 4, 2, 5]
Genres: ['Action', 'Comedy', 'Action', 'Documentary', 'Action', 'Mixed comedy/documentary']</code></pre>
</div>
</div>
<p><strong>Key observations</strong>:</p>
<ul>
<li><strong>Iteration 1</strong>: From the full pool, selects the highest-quality Action video (0.9) and highest-quality diverse option (Comedy, 0.7)</li>
<li><strong>Iteration 2</strong>: From remaining items, selects another Action video (0.85) paired with Documentary (0.6) for diversity</li>
<li><strong>Iteration 3</strong>: Clears the remaining pool with the last Action and Mixed genre video</li>
</ul>
<p>Notice how diversity is enforced <strong>within each window of 2 items</strong>, not just globally. This ensures users see varied content throughout their feed, not just at the top.</p>
</section>
<section id="comparing-single-pass-vs-windowed" class="level2">
<h2 class="anchored" data-anchor-id="comparing-single-pass-vs-windowed">Comparing Single-Pass vs Windowed</h2>
<p>Let’s compare the two approaches side-by-side:</p>
<div id="cell-81" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-12-29T03:52:13.994759Z&quot;,&quot;start_time&quot;:&quot;2025-12-29T03:52:13.987246Z&quot;}}" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Single-pass: select top-3 from full pool at once</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>L_full <span class="op">=</span> youtube_dpp_kernel(relevance, embeddings, alpha<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>single_pass <span class="op">=</span> greedy_map_dpp(L_full, k<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Windowed: select in windows of k=2</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>windowed_result <span class="op">=</span> youtube_dpp_ranking(relevance, embeddings, k<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.75</span>, sigma<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Comparison of top-3 selections:"</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Method'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Indices'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Genres'</span><span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Relevance'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"─"</span> <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>single_genres <span class="op">=</span> [genre[i] <span class="cf">for</span> i <span class="kw">in</span> single_pass]</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>single_rel <span class="op">=</span> [<span class="bu">float</span>(relevance[i]) <span class="cf">for</span> i <span class="kw">in</span> single_pass]</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Single-pass'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="bu">str</span>(single_pass)<span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(single_genres)<span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span>single_rel<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>windowed_top3 <span class="op">=</span> windowed_result[:<span class="dv">3</span>]</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>windowed_genres <span class="op">=</span> [genre[i] <span class="cf">for</span> i <span class="kw">in</span> windowed_top3]</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>windowed_rel <span class="op">=</span> [<span class="bu">float</span>(relevance[i]) <span class="cf">for</span> i <span class="kw">in</span> windowed_top3]</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Windowed (k=2)'</span><span class="sc">:&lt;20}</span><span class="ss"> </span><span class="sc">{</span><span class="bu">str</span>(windowed_top3)<span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(windowed_genres)<span class="sc">:&lt;50}</span><span class="ss"> </span><span class="sc">{</span>windowed_rel<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Comparison of top-3 selections:
Method               Indices         Genres                                             Relevance
────────────────────────────────────────────────────────────────────────────────────────────────────
Single-pass          [0, 3, 4]       Action, Comedy, Documentary                        [0.9, 0.7, 0.6]
Windowed (k=2)       [0, 3, 1]       Action, Comedy, Action                             [0.9, 0.7, 0.85]</code></pre>
</div>
</div>
<p>The windowed approach includes Video 1 (Action, 0.85) in the top-3 because it was selected in the second window after Videos 0 and 3 were removed. This demonstrates how window size k affects the ranking: smaller windows enforce local diversity but may allow similar items to appear nearby across window boundaries.</p>
<p>In the paper, it’s mentioned that typically the candidate pool is several hundreds of videos and sub-window size is a dozen (12) or so videos.</p>
<p>The windowed algorithm is YouTube’s production solution for bringing the mathematical elegance of DPPs to real-world scale. By processing items in batches, it maintains diversity guarantees while handling feeds with thousands of candidates in milliseconds.</p>
</section>
</section>
<section id="system-design-integration" class="level1">
<h1>System Design Integration</h1>
<p>Now that we’ve covered DPP theory and implementation, let’s see how it fits into a production recommendation system. Recall from <a href="https://aayushmnit.com/posts/2025-12-25-DiversityMMRPart1/DiversityMMRPart1.html#system-design-integration">Part 1</a> the standard recommendation pipeline:</p>
<figure align="center" class="figure">
<img src="./dpp_pipeline.png" style="width:100%" class="figure-img">
<figcaption align="center">
Figure 4: Typical RecSys pipeline showing where DPP fits in the recommendation pipeline
</figcaption>
</figure>
<p>DPPs slot into the <strong>Re-ranking</strong> stage, right where we used MMR in Part 1. Here’s how the stages work together:</p>
<p><strong>1. Candidate Generation (Recall)</strong></p>
<ul>
<li>Retrieve ~1000 candidates from multiple sources (collaborative filtering, content-based, trending)</li>
<li>Goal: High recall, cast a wide net</li>
<li>Output: Large pool of potentially relevant items</li>
</ul>
<p><strong>2. Scoring (Ranking)</strong></p>
<ul>
<li>ML model predicts relevance for each candidate (e.g., click probability, watch time)</li>
<li>Features: user history, item metadata, context</li>
<li>Output: Relevance scores <code>q_i</code> for each item, typically in 200-500 candidates</li>
</ul>
<p><strong>3. Re-ranking (Diversity)</strong></p>
<ul>
<li><strong>This is where DPP comes in</strong></li>
<li>Input: Scored candidates + content embeddings</li>
<li>Build kernel matrix: <code>L[i,j] = α × q_i × q_j × exp(-D_ij / 2σ²)</code></li>
<li>Apply windowed DPP to produce final ranked list</li>
<li>Output: Diverse, high-quality feed. Batches of size 6-12 candidates</li>
</ul>
<p><strong>4. Business Logic</strong></p>
<ul>
<li>Apply final filters (content policy, already-seen, etc.)</li>
<li>Insert ads, promotions</li>
<li>Output: User-facing feed</li>
</ul>
<p>The key advantage of DPPs is that they give you a mathematically principled way to balance quality and diversity, backed by decades of research in probability theory. Once you understand the volume-based intuition, the system becomes just as interpretable as MMR but with stronger theoretical guarantees.</p>
</section>
<section id="key-takeaways" class="level1">
<h1>Key Takeaways</h1>
<ul>
<li><p><strong>DPPs provide a mathematically principled framework for diversity</strong>. Unlike greedy approaches like MMR that make local decisions, DPPs evaluate entire sets at once through determinants. This volume-based intuition (diverse sets span more space) translates directly into probability: <code>P(Y) ∝ det(L_Y)</code>.</p></li>
<li><p><strong>The quality-diversity decomposition maps naturally to production recsys</strong>. The kernel formulation <code>L[i,j] = α × q_i × q_j × similarity(i,j)</code> cleanly separates relevance (from your ML model) and diversity (from content embeddings). You get two interpretable knobs: <code>α</code> controls how much diversity matters, <code>σ</code> controls what counts as “similar.”</p></li>
<li><p><strong>Greedy MAP is deterministic and faster</strong>. While exact MAP inference is NP-hard, the greedy algorithm runs in <code>O(Nk²)</code> time and provides strong approximations. Unlike sampling-based approaches, it’s deterministic and stable, making it suitable for A/B testing and debugging.</p></li>
<li><p><strong>YouTube’s windowed approach scales to video feeds</strong>. By processing candidates in batches of k items (typically 6-12), the algorithm maintains diversity throughout long feeds, not just at the top. This makes DPPs practical for ranking hundreds or thousands of candidates in milliseconds.</p></li>
</ul>
</section>
<section id="references-further-reading" class="level1">
<h1>References &amp; Further Reading</h1>
<ul>
<li><a href="https://arxiv.org/abs/1207.6083">Determinantal Point Processes for Machine Learning</a> (Kulesza &amp; Taskar, 2012) - The definitive tutorial covering DPP theory, algorithms, and applications. Highly readable despite the math.</li>
<li><a href="https://dl.acm.org/doi/epdf/10.1145/3269206.3272018">Practical Diversified Recommendations on YouTube with Determinantal Point Processes</a> (Cheng et al., 2018) - YouTube’s paper describing their windowed algorithm and kernel parameterization. This is the blueprint for production DPP systems.</li>
</ul>
<p><strong>Previous blog post:</strong></p>
<ul>
<li><a href="https://aayushmnit.com/posts/2025-12-25-DiversityMMRPart1/DiversityMMRPart1.html">Part 1: Diversity in Recommendations using MMR</a> - My previous post covering Maximal Marginal Relevance as a simpler alternative to DPPs.</li>
</ul>
<p>I hope you found this deep dive into DPPs useful! If you’re implementing diversity in your recommendation system, I’d love to hear about your experience. Connect with me on <a href="https://www.linkedin.com/in/aayushmnit/">LinkedIn</a> to share your thoughts or questions.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/aayushmnit\.com\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/aayushmnit/aayushmnit.github.io/blob/main/posts/2025-12-28-DiversityDPPPart2/DiversityDPPPart2.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/aayushmnit/aayushmnit.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>